- [버스 프로토콜](#버스-프로토콜)
  - [CAN 버스](#can-버스)
  - [OBD-II 커넥터](#obd-ii-커넥터)

# 버스 프로토콜

+ 차량 내부 네트워크의 패킷 전송을 관리
+ 일부 네트워크와 백여 개 센서들이 이를 통해 통신
+ 정해진 시간에 메시지 전송해 차량 동작 제어와 차량 내 정보 전달
+ 제조사는 적합한 버스와 프로토콜 선택
  + OBD-2 커넥터에 연결되는 CAN 버스 프로토콜은 표준적임
  + 차량 CAN 버스에 전송되는 패킷들이 표준화되지 않음을 의미

+ 고속 버스 라인: RPM 관리, 브레이크 등
+ 중속/저속 버스 라인: 문 개폐, 에어컨 제어 등의 상대적으로 중요치 않은 통신

## CAN 버스

+ 제조업과 차량 산업에서 사용되는 단순한 프로토콜
+ CANH(high), CANL(low) 전선 사용해 버스 구성 (꼬임쌍선 twisted pair)
  + 차동 신호
    + 신호 발생 시 하나의 전선에서 전압 발생시키고 다른 하나는 동일 양만큼 전압 낮춤
    + 노이즈에 대한 고장 감내 체계가 갖춰진 환경에서 사용됨(Ex. 차량 시스템, 생산 시스템)
  + 센서와 ECU들은 송수신기를 갖고 있어 두 신호가 발생했는지 감지하고, CAN 신호라고 판단되지 않으면 노이즈로 판단해 무시
+ 버스의 양 종단 처리를 위해 120옴 종단 저항 연결해야 함
+ 종단 디바이스가 반드시 존재하지 않아도 됨
+ 기존 종단 디바이스를 CAN 버스 태핑(물리적 스니핑)을 위해 제거할 시 터미네이션 저항을 고려해야 함
+ 패킷 구성
  + 표준형 패킷
    + ID: CAN 패킷이 브로드캐스팅 됐을 때 디바이스를 식별하는 ID가 작을수록 우선순위가 높은 패킷으로 판단(11bit)
    + Identifier Extension(IDE): 표준형 CAN에서 이 필드의 값은 항상 0
    + Data Length Code(DLC): 데이터 길이(0~8 바이트)
    + Data: 데이터가 저장되는 필드(~8바이트, 임의 변경해 확장하기도 함)
  + 확장형 패킷
    + 표준형 패킷과 유사하나 패킷을 연결해 더 긴 ID 사용 가능(18bit)
    + 표준형 패킷과 호환성 유지하도록 설계
    + 플래그에서 표준형 패킷과 차이
      + 표준형 패킷의 RTR(Remote Transmission Request) 대신 SRR(Substitute Remote Request) 사용하고 이 값이 1로 설정됨
      + IDE 패킷 값이 1
  + 동일 네트워크 상 CAN 패킷을 모두 볼 수 있어 누가 어떤 내용의 패킷을 전송했는지 패킷 내에 저장해 전송할 필요가 없음
  + 특정 제어기인 척 가짜 패킷을 전송하기 쉬움

## OBD-II 커넥터

+ 차량 내부 네트워크와 통신
+ 조향 핸들 아래 주변과 대시보드 주변에 위치
+ 이에 모든 버스가 연결되어 있는 건 아님